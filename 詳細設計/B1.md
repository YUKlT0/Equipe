## 3. 機能設計

### 3.1. 機能一覧

| 機能ID | 機能名                     | 概要                                                                      | MoSCoW | 備考                                                                    |
| ------ | -------------------------- | ------------------------------------------------------------------------- | ------ | ----------------------------------------------------------------------- |
| F01    | ログイン/ログアウト機能    | 登録済みのユーザーが認証してログイン/ログアウトできる機能。               | Must   | JWTなどの認証方式を想定。ログイン状態はセッションまたはトークンで管理。 |
| F02    | ユーザー情報登録機能       | 新規ユーザーが会員登録し、ユーザー情報をDBに登録する。                    | Must   | メールアドレス、パスワード、氏名等を登録。                              |
| F03    | マイページ表示・編集機能   | ログインユーザーが登録済み情報を表示・変更できる機能。                    | Should | 登録情報の編集・パスワード変更等。                                      |
| F04    | 商品一覧表示機能           | 商品をカテゴリ別に分類し、無限スクロールで一覧表示。                      | Must   | 商品件数が多くてもUXを損なわないよう無限スクロールを実装。              |
| F05    | 商品詳細ページ表示         | 商品IDに紐づいた詳細情報（写真、価格、素材、納期予定など）を表示。        | Must   | 商品IDによる動的ルーティング。画像複数対応も想定。                      |
| F06    | カテゴリ絞込               | カテゴリ別に商品を絞り込んで表示する。                                    | Should | 簡易検索機能もCouldで対応可能。                                         |
| F07    | カート追加・削除機能       | 商品一覧または詳細から商品をカートに追加・削除できる機能。                | Must   | 商品ID、数量、価格などをカート情報に追加。                              |
| F08    | カート表示・数量編集機能   | カート内商品の一覧表示・数量の増減・削除ができる。                        | Must   | 小計、合計金額も表示。                                                  |
| F09    | カート状態保持機能         | セッション/ローカルストレージにより、未ログイン状態でもカート情報を保持。 | Should | ログイン後にサーバ側カートとマージする想定。                            |
| F10    | 注文情報入力               | 氏名・住所・連絡先などを入力するフォーム画面を表示。                      | Must   | 会員は自動入力。非会員は手入力。                                        |
| F11    | 注文情報確認               | 入力内容・カート内容を最終確認する画面を表示。                            | Must   | 注文内容、配送先情報などの確認。                                        |
| F12    | 注文確定                   | 確定ボタン押下時に注文情報をDBに登録。                                    | Must   | 実際の決済処理は行わない。                                              |
| F13    | 注文完了表示               | 正常に注文が完了したことを伝える完了画面を表示。                          | Must   | 注文番号などを表示。                                                    |
| F14    | スマホUI最適化機能         | 各画面でレスポンシブデザインによりスマホでも最適表示されるよう対応。      | Must   | スマホ特有のナビゲーションUIを適用（ハンバーガーメニュー等）。          |
| F15    | 商品情報管理機能           | 管理者が商品情報の追加・削除・編集を行う機能。                            | Must   | 管理者認証後のみアクセス可能。                                          |
| F16    | 注文情報確認機能（管理者） | 管理者が注文情報を確認できる機能。                                        | must   | 商品発送管理などの発展機能のベースとして。                              |

---

### 3.2. 機能詳細

主要機能における、ユーザー操作から始まるフロントエンドとバックエンドAPI間の連携、およびバックエンド内部のクラス間連携の概要をシーケンス図で示します。

（APIの詳細な仕様は「５.インターフェース仕様（API）」を参照してください。

#### 3.2.1.  ログイン/ログアウト機能

ユーザーがECサイトにログインし、セッションにより認証状態を維持する機能です。またログアウト操作により認証状態を解除します。

#### 3.2.2 ユーザー情報登録機能

新規ユーザーが会員情報（ユーザーID・パスワード・氏名・住所・メールアドレス）を入力し、DBに登録するフローです。

【ここにシーケンス図】

<div class=mermaid>
sequenceDiagram
participant ユーザー
participant フロントエンド
participant バックエンド
participant DB

ユーザー->>フロントエンド: 会員登録情報入力
フロントエンド->>バックエンド: 会員登録APIリクエスト（氏名・住所・メール・PWなど）
バックエンド->>DB: 会員情報をINSERT（PWはハッシュ化）
DB-->>バックエンド: 登録完了
バックエンド-->>フロントエンド: 登録成功レスポンス
フロントエンド-->>ユーザー: ログイン状態に遷移

</div>

#### 3.2.3 商品一覧表示機能

ユーザーが商品一覧ページにアクセスした際の処理フローです。

【ここにシーケンス図】

<div class=mermaid>
sequenceDiagram
participant ユーザー
participant フロントエンド
participant バックエンド
participant DB

ユーザー->>フロントエンド: 商品一覧ページアクセス
フロントエンド->>バックエンド: 商品一覧APIリクエスト
バックエンド->>DB: PRODUCT + CATEGORY + IMAGE をJOINして取得
DB-->>バックエンド: 商品データ返却
バックエンド-->>フロントエンド: 商品一覧JSON返却
フロントエンド-->>ユーザー: 商品一覧表示

</div>

#### 3.2.4 商品詳細表示機能

ユーザーが商品一覧から特定の商品を選択し、詳細情報（商品画像・価格・素材・納期）を表示する際の処理フローです。

【ここにシーケンス図】

#### 3.2.5 カート追加・削除機能

ユーザーが商品詳細ページで「カートに入れる」ボタンを押した際の処理フローです。カート情報はHTTPセッションで管理します。
未ログインユーザー: 商品の追加・削除はローカルストレージやセッションに保存し、一時的にカート状態を保持。

ログインユーザー: APIサーバーのカート情報DBと連携して商品を管理。ログイン時はローカルのカートとサーバー側カートをマージ。

【ここにシーケンス図】

**補足:**

- カートオブジェクト (`Cart`) やカート内アイテム (`CartItem`) のクラス設計は「4. クラス設計」で定義します。
- Spring Boot標準のHttpSession利用を基本とします。

#### 3.2.6 カート表示・編集機能

ユーザーがカートの中身を確認、数量変更、削除する際の処理フローです。
未ログインユーザー: ローカルストレージのカート情報を画面表示し、数量変更・削除操作を反映。

ログインユーザー: サーバーのカート情報をAPI経由で取得し表示。数量変更や削除はDBへ反映。

**カート情報取得 (GET /api/cart)**

【ここにシーケンス図】

**カート数量変更 (PUT /api/cart/items/{itemId})**

【ここにシーケンス図】

**カート商品削除 (DELETE /api/cart/items/{itemId})** (上記PUTと同様の流れ)

#### 3.2.7 注文情報入力機能

注文に必要な氏名・住所・連絡先等の入力フォームを表示。
会員は登録情報を自動補完。

非会員は手入力で情報を登録。
【ここにシーケンス図】

#### 3.2.8 注文確定処理

ユーザーが注文確認画面で「注文を確定する」ボタンを押した際の処理フローです。
【ここにシーケンス図】

**補足:**

- `@Transactional` アノテーションを `OrderService#placeOrder` メソッドに付与し、DB操作の原子性を保証します。

#### 3.2.9 商品情報管理機能（管理者）

管理者認証後、商品情報の追加・編集・削除を行う機能です。
【ここにシーケンス図】

#### 3.2.10 注文情報確認機能（管理者）

管理者が注文情報一覧・詳細で閲覧可能。発送管理などの拡張の基盤となります。
【ここにシーケンス図】

## 4. クラス設計


4.1　クラス構成図

<div class=mermaid>
classDiagram
    %% Controllers
    class ProductController
    class CartController
    class OrderController

    %% Services
    class ProductService
    class CartService
    class OrderService

    %% Repositories
    class ProductRepository
    class OrderRepository
    class OrderDetailRepository

    %% Entities
    class Product
    class Order
    class OrderDetail

    %% DTOs（代表例）
    class ProductListItem
    class ProductDetail
    class Cart
    class CartItem
    class OrderRequest
    class OrderResponse
    class CustomerInfo

    %% Controller-→Service
    ProductController --> ProductService
    CartController --> CartService
    OrderController --> OrderService
    OrderController --> CartService

    %% Service-→Repository
    ProductService --> ProductRepository
    OrderService --> OrderRepository
    OrderService --> OrderDetailRepository
    OrderService --> ProductRepository
    CartService --> ProductRepository

    %% Repository-→Entity
    ProductRepository --> Product
    OrderRepository --> Order
    OrderDetailRepository --> OrderDetail

    %% Service-→DTO
    ProductService ..> ProductListItem
    ProductService ..> ProductDetail
    CartService ..> Cart
    CartService ..> CartItem
    OrderService ..> OrderResponse
    OrderService ..> CustomerInfo

    %% Controller-→DTO
    ProductController ..> ProductListItem
    ProductController ..> ProductDetail
    CartController ..> Cart
    CartController ..> CartItem
    OrderController ..> OrderRequest
    OrderController ..> OrderResponse

  </div>

4.2 クラス設計（これはボツ）
<div class=mermaid>
classDiagram

%% ==== Entity ====
class Product {

- String id
- String name
- String description
- BigDecimal price
- String categoryId
  }

class Category {

- String id
- String name
  }

class ProductImage {

- String id
- String productId
- String imageUrl
- int displayOrder
  }

class Customer {

- String id
- String name
- String email
- String hashedPassword
- String address
- boolean isMember
  }

class Order {

- String id
- String customerId
- LocalDateTime orderDate
- BigDecimal totalAmount
- String status
  }

class OrderDetail {

- String id
- String orderId
- String productId
- int quantity
- BigDecimal unitPrice
  }

%% ==== Repository ====
class ProductRepository
class CustomerRepository
class OrderRepository
class OrderDetailRepository

%% ==== Service ====
class ProductService {

+ List `<ProductListItemDto>` getAllProducts()
+ ProductDetailDto getProductDetail(String productId)
  }

class OrderService {

+ String createOrder(OrderRequestDto dto)
+ List `<OrderSummaryDto>` getCustomerOrders(String customerId)
  }

class CustomerService {

+ void register(CustomerRegistrationDto dto)
+ CustomerDto authenticate(String email, String password)
  }

%% ==== Controller ====
class ProductController {

+ getAllProducts(): List `<ProductListItemDto>`
+ getProductDetail(String id): ProductDetailDto
  }

class OrderController {

+ placeOrder(OrderRequestDto): String
+ getMyOrders(): List `<OrderSummaryDto>`
  }

class AuthController {

+ register()
+ login()
+ logout()
  }

%% ==== DTO ====
class ProductListItemDto {

- String id
- String name
- BigDecimal price
- String thumbnailUrl
  }

class ProductDetailDto {

- String id
- String name
- String description
- BigDecimal price
- List `<String>` imageUrls
  }

class OrderRequestDto {

- String customerId
- List `<OrderItemDto>` items
- String address
- String paymentMethod
  }

class OrderItemDto {

- String productId
- int quantity
  }

class OrderSummaryDto {

- String orderId
- LocalDateTime date
- BigDecimal total
- String status
  }

class CustomerRegistrationDto
class CustomerDto

%% ==== Relationships ====
Product --> Category : belongsTo
Product --> ProductImage : has*
Order --> OrderDetail : has*
OrderDetail --> Product : refers
Order --> Customer : belongsTo
ProductController --> ProductService
OrderController --> OrderService
AuthController --> CustomerService
ProductService --> ProductRepository
OrderService --> OrderRepository
OrderService --> OrderDetailRepository
CustomerService --> CustomerRepository

</div>
