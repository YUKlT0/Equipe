## 3. 機能設計

### 3.1. 機能一覧

| 機能ID | 機能名                     | 概要                                                                      | MoSCoW | 備考                                                                    |
| ------ | -------------------------- | ------------------------------------------------------------------------- | ------ | ----------------------------------------------------------------------- |
| F01    | ログイン/ログアウト機能    | 登録済みのユーザーが認証してログイン/ログアウトできる機能。               | Must   | JWTなどの認証方式を想定。ログイン状態はセッションまたはトークンで管理。 |
| F02    | ユーザー情報登録機能       | 新規ユーザーが会員登録し、ユーザー情報をDBに登録する。                    | Must   | メールアドレス、パスワード、氏名等を登録。                              |
| F03    | マイページ表示・編集機能   | ログインユーザーが登録済み情報を表示・変更できる機能。                    | Should | 登録情報の編集・パスワード変更等。                                      |
| F04    | 商品一覧表示機能           | 商品をカテゴリ別に分類し、無限スクロールで一覧表示。                      | Must   | 商品件数が多くてもUXを損なわないよう無限スクロールを実装。              |
| F05    | 商品詳細ページ表示         | 商品IDに紐づいた詳細情報（写真、価格、素材、納期予定など）を表示。        | Must   | 商品IDによる動的ルーティング。画像複数対応も想定。                      |
| F06    | カテゴリ絞込               | カテゴリ別に商品を絞り込んで表示する。                                    | Should | 簡易検索機能もCouldで対応可能。                                         |
| F07    | カート追加機能       | 商品一覧または詳細から商品をカートに追加できる機能。                | Must   | 商品ID、数量、価格などをカート情報に追加。                              |
| F08    | カート表示・数量編集機能   | カート内商品の一覧表示・数量の増減・削除ができる。                        | Must   | 小計、合計金額も表示。                                                  |
| F09    | カート状態保持機能         | セッション/ローカルストレージにより、未ログイン状態でもカート情報を保持。 | Should | ログイン後にサーバ側カートとマージする想定。                            |
| F10    | 注文情報入力               | 氏名・住所・連絡先などを入力するフォーム画面を表示。                      | Must   | 会員は自動入力。非会員は手入力。                                        |
| F11    | 注文情報確認               | 入力内容・カート内容を最終確認する画面を表示。                            | Must   | 注文内容、配送先情報などの確認。                                        |
| F12    | 注文確定                   | 確定ボタン押下時に注文情報をDBに登録。                                    | Must   | 実際の決済処理は行わない。                                              |
| F13    | 注文完了表示               | 正常に注文が完了したことを伝える完了画面を表示。                          | Must   | 注文番号などを表示。                                                    |
| F14    | スマホUI最適化機能         | 各画面でレスポンシブデザインによりスマホでも最適表示されるよう対応。      | Must   | スマホ特有のナビゲーションUIを適用（ハンバーガーメニュー等）。          |
| F15    | 商品情報管理機能           | 管理者が商品情報の追加・削除・編集を行う機能。                            | Must   | 管理者認証後のみアクセス可能。                                          |
| F16    | 注文情報確認機能（管理者） | 管理者が注文情報を確認できる機能。                                        | must   | 商品発送管理などの発展機能のベースとして。                              |

---

### 3.2. 機能詳細

主要機能における、ユーザー操作から始まるフロントエンドとバックエンドAPI間の連携、およびバックエンド内部のクラス間連携の概要をシーケンス図で示します。

（APIの詳細な仕様は「５.インターフェース仕様（API）」を参照してください。

#### 3.2.1.  ログイン/ログアウト機能

ユーザーがECサイトにログインし、セッションにより認証状態を維持する機能です。またログアウト操作により認証状態を解除します。

#### 3.2.2 ユーザー情報登録機能

新規ユーザーが会員情報（ユーザーID・パスワード・氏名・住所・メールアドレス）を入力し、DBに登録するフローです。


<div class=mermaid>
sequenceDiagram
participant ユーザー
participant フロントエンド
participant バックエンド
participant DB

ユーザー->>フロントエンド: 会員登録情報入力
フロントエンド->>バックエンド: 会員登録APIリクエスト（氏名・住所・メール・PWなど）
バックエンド->>DB: 会員情報をINSERT（PWはハッシュ化）
DB-->>バックエンド: 登録完了
バックエンド-->>フロントエンド: 登録成功レスポンス
フロントエンド-->>ユーザー: ログイン状態に遷移

</div>

#### 3.2.3 商品一覧表示機能

ユーザーが商品一覧ページにアクセスした際の処理フローです。


<div class=mermaid>
sequenceDiagram
participant ユーザー
participant フロントエンド
participant バックエンド
participant DB

ユーザー->>フロントエンド: 商品一覧ページアクセス
フロントエンド->>バックエンド: 商品一覧APIリクエスト
バックエンド->>DB: PRODUCT + CATEGORY + IMAGE をJOINして取得
DB-->>バックエンド: 商品データ返却
バックエンド-->>フロントエンド: 商品一覧JSON返却
フロントエンド-->>ユーザー: 商品一覧表示

</div>

#### 3.2.4 商品詳細表示機能

ユーザーが商品一覧から特定の商品を選択し、詳細情報（商品画像・価格・素材・納期）を表示する際の処理フローです。

【ここにシーケンス図】

<div class=mermaid>
sequenceDiagram
    participant ユーザー
    participant フロントエンド
    participant バックエンド
    participant DB

    ユーザー ->> フロントエンド: 商品をクリック
    フロントエンド ->> バックエンド: 商品詳細APIリクエスト（GET /api/products/{productId}）
    バックエンド ->> DB: 商品情報・画像・カテゴリ情報をJOINして取得
    DB -->> バックエンド: 商品詳細データを返却
    バックエンド -->> フロントエンド: 商品詳細JSONを返却
    フロントエンド -->> ユーザー: 商品詳細ページに表示（画像・価格・素材・納期など）

</div>

#### 3.2.5 カート追加機能

ユーザーが商品詳細ページで「カートに入れる」ボタンを押した際の処理フローです。カート情報はHTTPセッションで管理します。

 APIサーバーのカート情報DBと連携して商品を管理。ログイン時はローカルのカートとサーバー側カートをマージ。



<div class="mermaid">

sequenceDiagram
participant ユーザー
participant フロントエンド
participant バックエンド
participant DB

ユーザー ->> フロントエンド: 「カートに入れる」ボタン押下
フロントエンド ->> バックエンド: カート追加APIリクエスト（商品ID, 数量）
activate バックエンド

alt セッションに既存カートあり
    バックエンド ->> DB: カート情報取得
    DB -->> バックエンド: カートオブジェクト返却
    alt 商品がすでに存在
        バックエンド ->> DB: 数量加算・更新
    else 商品が未登録
        バックエンド ->> DB: 新規CartItem追加
    end
else カート未作成
    バックエンド ->> DB: 新規カート作成 & CartItem追加
end

DB -->> バックエンド: 更新結果
バックエンド -->> フロントエンド: 追加完了レスポンス
フロントエンド -->> ユーザー: カート更新（アイコンに反映）
</div>




**補足:**

- カートオブジェクト (`Cart`) やカート内アイテム (`CartItem`) のクラス設計は「4. クラス設計」で定義します。
- Spring Boot標準のHttpSession利用を基本とします。

#### 3.2.6 カート表示・編集機能

ユーザーがカートの中身を確認、数量変更、削除する際の処理フローです。

 サーバーのカート情報をAPI経由で取得し表示。数量変更や削除はDBへ反映。


**カート情報取得 (GET /api/cart)**

<div class="mermaid">

sequenceDiagram
participant ユーザー
participant フロントエンド
participant バックエンド
participant DB

ユーザー ->> フロントエンド: カートページに遷移
フロントエンド ->> バックエンド: GET /api/cart（JWT付き）
バックエンド ->> DB: ユーザーのカート情報を取得
DB -->> バックエンド: カート情報返却
バックエンド -->> フロントエンド: JSONでカート情報返却
フロントエンド -->> ユーザー: カート画面に反映

</div>



**カート数量変更 (PUT /api/cart/items/{itemId})**

**カート商品削除 (DELETE /api/cart/items/{itemId})** (上記PUTと同様の流れ)


<div class="mermaid">

sequenceDiagram
participant ユーザー
participant フロントエンド
participant バックエンド
participant DB

ユーザー ->> フロントエンド: 数量変更操作（+ / − ボタン）

alt 新しい数量 > 0（変更）
    フロントエンド ->> バックエンド: PUT /api/cart/items/{itemId}（数量: n）
    バックエンド ->> DB: カートアイテムの数量を更新
    DB -->> バックエンド: 更新完了
    バックエンド -->> フロントエンド: 成功レスポンス
    フロントエンド -->> ユーザー: UIに新しい数量を反映

else 新しい数量 = 0（削除）
    フロントエンド ->> バックエンド: DELETE /api/cart/items/{itemId}
    バックエンド ->> DB: カートアイテムを削除
    DB -->> バックエンド: 削除完了
    バックエンド -->> フロントエンド: 成功レスポンス
    フロントエンド -->> ユーザー: UIから該当商品を削除
end

</div>


<div class="mermaid">

sequenceDiagram
participant ユーザー
participant フロントエンド（ブラウザ）

ユーザー ->> フロントエンド: 数量変更操作（+ / − ボタン）

alt 新しい数量 > 0（変更）
    フロントエンド ->> フロントエンド: localStorage内の該当商品数量を更新
    フロントエンド -->> ユーザー: UIに新しい数量を反映

else 新しい数量 = 0（削除）
    フロントエンド ->> フロントエンド: localStorageから該当商品を削除
    フロントエンド -->> ユーザー: UIから該当商品を削除
end

</div>

#### 3.2.7 注文情報入力機能

注文に必要な氏名・住所・連絡先等の入力フォームを表示。
会員は登録情報を自動補完。

非会員は手入力で情報を登録。

<div class="mermaid">

sequenceDiagram
participant ユーザー
participant フロントエンド
participant バックエンド
participant DB

ユーザー ->> フロントエンド: 注文情報入力ページへアクセス

alt ログイン済み（会員）
    フロントエンド ->> バックエンド: ユーザー情報取得APIリクエスト
    バックエンド ->> DB: ユーザー情報検索
    DB -->> バックエンド: ユーザー情報返却
    バックエンド -->> フロントエンド: ユーザー情報レスポンス
    フロントエンド -->> ユーザー: 入力フォームに登録情報を自動セット

else 未ログイン（非会員）
    フロントエンド -->> ユーザー: 空の入力フォームを表示（手入力）
end

ユーザー ->> フロントエンド: 注文情報を入力・編集後、送信

フロントエンド ->> バックエンド: 入力内容送信APIリクエスト

alt 入力内容不備あり（バリデーションエラー）
    バックエンド -->> フロントエンド: エラーレスポンス（エラーメッセージ）
    フロントエンド -->> ユーザー: 「ここ、空白だよ？そんなシンプルなミス、君らしくないぞ！」を表示し再入力促す

else 入力内容正常
    バックエンド -->> フロントエンド: 正常レスポンス
    フロントエンド -->> ユーザー: 確認画面へ遷移
end

</div>

#### 3.2.8 注文確定処理

ユーザーが注文確認画面で「注文を確定する」ボタンを押した際の処理フローです。

<div class="mermaid">

sequenceDiagram
participant ユーザー
participant フロントエンド
participant バックエンド
participant DB

ユーザー ->> フロントエンド: 注文確認画面で「注文を確定する」ボタン押下

フロントエンド ->> バックエンド: 注文確定APIリクエスト（注文情報・カート内容）

activate バックエンド

バックエンド ->> DB: 注文情報登録（@Transactional）
DB -->> バックエンド: 登録完了

バックエンド -->> フロントエンド: 注文確定成功レスポンス（注文番号など）

deactivate バックエンド

フロントエンド ->> ユーザー: 注文完了画面に画面遷移・表示（注文番号など）

</div>

**補足:**

- `@Transactional` アノテーションを `OrderService#placeOrder` メソッドに付与し、DB操作の原子性を保証します。

#### 3.2.9 商品情報管理機能（管理者）

管理者認証後、商品情報の追加・編集・削除を行う機能です。

<div class="mermaid">

sequenceDiagram
participant 管理者
participant 管理画面
participant バックエンド
participant DB

管理者 ->> 管理画面: 管理画面にログイン・アクセス
管理画面 ->> バックエンド: 認証APIリクエスト（JWTなど）
バックエンド ->> DB: ユーザー認証情報確認
DB -->> バックエンド: 認証結果返却
バックエンド -->> 管理画面: 認証トークン返却
管理画面 -->> 管理者: 管理画面表示

alt 新規商品追加
    管理者 ->> 管理画面: 商品情報入力（商品名・価格・説明・画像）
    管理画面 ->> バックエンド: 商品追加APIリクエスト
    バックエンド ->> DB: INSERT商品情報
    DB -->> バックエンド: 登録完了レスポンス
    バックエンド -->> 管理画面: 登録成功レスポンス
    管理画面 -->> 管理者: 商品追加完了メッセージ表示

else 商品編集
    管理者 ->> 管理画面: 商品一覧から対象商品選択・編集内容入力
    管理画面 ->> バックエンド: 商品更新APIリクエスト
    バックエンド ->> DB: UPDATE商品情報
    DB -->> バックエンド: 更新完了レスポンス
    バックエンド -->> 管理画面: 更新成功レスポンス
    管理画面 -->> 管理者: 商品更新完了メッセージ表示

else 商品削除／非公開設定
    管理者 ->> 管理画面: 削除・非公開操作実行
    管理画面 ->> バックエンド: 商品削除／非公開APIリクエスト
    バックエンド ->> DB: DELETE または フラグ更新
    DB -->> バックエンド: 処理完了レスポンス
    バックエンド -->> 管理画面: 処理成功レスポンス
    管理画面 -->> 管理者: 削除／非公開完了メッセージ表示
end
</div>

#### 3.2.10 注文情報確認機能（管理者）

管理者が注文情報一覧・詳細で閲覧可能。発送管理などの拡張の基盤となります。

<div class="mermaid">

sequenceDiagram
participant 管理者
participant 管理画面
participant バックエンド
participant DB

管理者 ->> 管理画面: 管理画面にログイン・アクセス
管理画面 ->> バックエンド: 認証APIリクエスト
バックエンド ->> DB: 認証情報確認
DB -->> バックエンド: 認証結果返却
バックエンド -->> 管理画面: 認証トークン返却
管理画面 -->> 管理者: 管理画面表示

管理者 ->> 管理画面: 注文一覧ページを開く
管理画面 ->> バックエンド: 注文一覧取得APIリクエスト
バックエンド ->> DB: 注文情報取得（一覧）
DB -->> バックエンド: 注文一覧返却
バックエンド -->> 管理画面: 注文一覧レスポンス
管理画面 -->> 管理者: 注文一覧表示

管理者 ->> 管理画面: 注文詳細を選択
管理画面 ->> バックエンド: 注文詳細取得APIリクエスト
バックエンド ->> DB: 注文詳細情報取得
DB -->> バックエンド: 注文詳細返却
バックエンド -->> 管理画面: 注文詳細レスポンス
管理画面 -->> 管理者: 注文詳細表示
</div>
