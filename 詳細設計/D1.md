## 物理テーブル定義書
#### `CUSTOMER`テーブル

| 論理名 | 物理名 | 型 | サイズ | NULL | pk | FK | UQ | CHK | Index | デフォルト値 | 備考 |
|--|--|--|--|--|--|--|--|--|--|--|--|
| 会員ID | user_id | VARCHAR | 64 | NO | ○ |   |   |   | ○ |   |   |
| 氏名 | user_name | VARCHAR | 64 | YES |   |   |   |   |   |   |   |
| メールアドレス | user_email | VARCHAR | 255 | YES |   |   | ○ |   |   |   |   |
| ハッシュパスワード | user_password | VARCHAR | 255 | YES |   |   |   |   |   |   | ゲストはNULL |
| 住所 | user_address | TEXT |   | YES |   |   |   |   |   |   |   |
| 登録日時 | user_date | DATETIME |   | NO |   |   |   |   |   | CURRENT_TIMESTAMP |   |
| メンバーシップ | membership | BOOLEAN |   | NO |   |   |   | ● |   | false | true（会員）またはfalse（ゲスト） |

#### `ADMIN`テーブル

| 論理名 | 物理名 | 型 | サイズ | NULL | pk | FK | UQ | CHK | Index | デフォルト値 | 備考 |
|--|--|--|--|--|--|--|--|--|--|--|--|
| 管理者ID | admin_id | VARCHAR | 64 | NO | ○ |   |   |   | ○ |   |   |
| 管理者氏名 | admin_name | VARCHAR | 64 | NO |   |   |   |   |   |   |   |
| 管理者メールアドレス | admin_email | VARCHAR | 255 | NO |   |   | ○ |   |   |   |   |
| 管理者ハッシュパスワード | admin_password | VARCHAR | 255 | NO |   |   |   |   |   |   |   |
| 登録日時 | admin_date | DATETIME |   | NO |   |   |   |   |   | CURRENT_TIMESTAMP |   |

#### `ORDER`テーブル

| 論理名 | 物理名 | 型 | サイズ | NULL | pk | FK | UQ | CHK | Index | デフォルト値 | 備考 |
|--|--|--|--|--|--|--|--|--|--|--|--|
| 注文ID | order_id | VARCHAR | 64 | NO | ○ |   |   |   | ○ |   |   |
| 会員ID | user_id | VARCHAR | 64 | NO |   | ○ |   |   |   |   |   |
| 購入者氏名 | buyer_name | VARCHAR | 64 | NO |   |   |   |   |   |   |   |
| 購入者メールアドレス | buyer_email | VARCHAR | 255 | NO |   |   |   |   |   |   |   |
| 購入者住所 | buyer_address | TEXT |   | NO |   |   |   |   |   |   |   |
| 注文日時 | order_date | DATETIME |   | NO |   |   |   |   | ○ | CURRENT_TIMESTAMP |   |
| 配送先氏名 | ship_name | VARCHAR | 64 | NO |   |   |   |   |   |   |   |
| 配送先住所 | ship_address | TEXT |   | NO |   |   |   |   |   |   |   |
| 送料 | ship_fee | DECIMAL | 10,2 | NO |   |   |   | ● |   | 700 | ship_fee = 700 |
| 合計金額 | total_price | DECIMAL | 10,2 | NO |   |   |   | ● |   | 0.00 | total_price >= 0 |
| 決済方法 | pay_method | VARCHAR | 50 | NO |   |   |   | ● |   |   | 口座振込、代引き |
| 注文ステータス | order_status | VARCHAR | 50 | NO |   |   |   | ● |   |   | 受付済、決済済、出荷済、キャンセル、発送完了 |

#### `ORDER_DETAIL`テーブル

| 論理名 | 物理名 | 型 | サイズ | NULL | pk | FK | UQ | CHK | Index | デフォルト値 | 備考 |
|--|--|--|--|--|--|--|--|--|--|--|--|
| 注文詳細ID | detail_id | VARCHAR | 64 | NO | ○ |   |   |   | ○ |   |   |
| 注文ID | order_id | VARCHAR | 64 | NO |   | ○ |   |   |   |   |   |
| 商品ID | product_id | VARCHAR | 64 | NO |   | ○ |   |   |   |   |   |
| 数量 | detail_quantity | INT |   | NO |   |   |   | ● |   | 1 | detail_quantity >= 1 |
| 単価 | unit_price | DECIMAL | 10,2 | NO |   |   |   | ● |   | 0.00 | unit_price>=0 |


#### `PRODUCT`テーブル

| 論理名 | 物理名 | 型 | サイズ | NULL | pk | FK | UQ | CHK | Index | デフォルト値 | 備考 |
|--|--|--|--|--|--|--|--|--|--|--|--|
| 商品ID | product_id | VARCHAR | 64 | NO | ○ |   |   |   | ○ |   |   |
| 商品名 | product_name | VARCHAR | 255 | NO |   |   |   |   | ○ |   |   |
| 商品説明 | discription | TEXT |   | YES |   |   |   |   |   |   |   |
| 価格 | product_price | DECIMAL | 10,2 | NO |   |   |   | ● |   | 0.00 | product_price >= 0 |
| カテゴリID | category_id | VARCHAR | 64 | NO |   | ○ |   |   |   |   |   |

#### `PRODUCT_IMAGE`テーブル

| 論理名 | 物理名 | 型 | サイズ | NULL | pk | FK | UQ | CHK | Index | デフォルト値 | 備考 |
|--|--|--|--|--|--|--|--|--|--|--|--|
| 画像ID | image_id | VARCHAR | 64 | NO | ○ |   |   |   | ○ |   |   |
| 商品ID | product_id | VARCHAR | 64 | NO |   | ○ |   |   |   |   |   |
| 画像URL | image_url | VARCHAR | 1024 | NO |   |   |   |   |   |   |   |
| 表示順 | sort | INT |   | NO |   |   |   | ● |   | 0 | sort >= 0 |

#### `CATEGORY`テーブル

| 論理名 | 物理名 | 型 | サイズ | NULL | pk | FK | UQ | CHK | Index | デフォルト値 | 備考 |
|--|--|--|--|--|--|--|--|--|--|--|--|
| カテゴリID | category_id | VARCHAR | 64 | NO | ○ |   |   |   | ○ |   |   |
| カテゴリ名 | category_name | VARCHAR | 255 | NO |   |   | ○ |   | ○ |   | 一意制約 |

#### `CART`テーブル

| 論理名 | 物理名 | 型 | サイズ | NULL | pk | FK | UQ | CHK | Index | デフォルト値 | 備考 |
|--|--|--|--|--|--|--|--|--|--|--|--|
| カートID | cart_id | VARCHAR | 64 | NO | ○ |   |   |   | ○ |   |   |
| 会員ID | user_id | VARCHAR | 64 | NO |   | ○ |   |   |   |   |   |
| 作成日時 | create | DATETIME |   | NO |   |   |   |   |   | CURRENT_TIMESTAMP |   |
| 更新日時 | update | DATETIME |   | NO |   |   |   |   |   | CURRENT_TIMESTAMP |   |

#### `CART_ITEM`テーブル

| 論理名 | 物理名 | 型 | サイズ | NULL | pk | FK | UQ | CHK | Index | デフォルト値 | 備考 |
|--|--|--|--|--|--|--|--|--|--|--|--|
| カート商品ID | cart_item | VARCHAR | 64 | NO | ○ |   |   |   | ○ |   |   |
| カートID | cart_id | VARCHAR | 64 | NO |   | ○ |   |   |   |   | 外部キーにON DELETE CASCADEを設定。カート削除時に関連カート商品も削除される。 |
| 商品ID | product_id | VARCHAR | 64 | NO |   | ○ |   |   |   |   |   |
| 数量 | cart_quantity | INT |   | NO |   |   |   | ● |   | 1 | cart_quantity >= 1 |


## 主要CRUD操作SQL

### 

### 自動削除SQL

####  7日以上前のカート削除
DELETE FROM cart
WHERE created_at < CURRENT_DATE - INTERVAL '7 days';
**※関連する cart_itemも削除**


#### 30日以上前に登録された非会員で、注文実績がない顧客を削除
DELETE FROM customer
WHERE membership = false
  AND user_date < CURRENT_DATE - INTERVAL '30 days'
  AND user_id NOT IN (
    SELECT DISTINCT user_id FROM orders
  );


# トランザクションが必須な処理

## 1. 注文確定処理（会員）

- **対象テーブル**  
  - `ORDER` 登録  
  - `ORDER_DETAIL` 登録  
  - `CART_ITEM` 削除  
  - `CART` 削除  

- **理由**  
  注文情報とカートの整合性を保つため、すべての処理をまとめてトランザクション管理する必要がある。

<div class = "mermaid">
stateDiagram-v2
    処理開始 --> カート確認

    カート確認 --> 注文登録（INSERT） : 注文確定
    注文登録（INSERT） --> Rollback : エラー
    注文登録（INSERT） --> 注文詳細登録（INSERT）:OK
    
    注文詳細登録（INSERT）--> Rollback :エラー

    注文詳細登録（INSERT）-->カート削除(DELETE):OK

    カート削除(DELETE)-->Rollback:エラー

    カート削除(DELETE)-->Commit:OK

    Rollback-->エラー処理

    Commit-->注文完了
</div>

## 2. 注文確定処理（ゲスト）
- **対象テーブル**  
  - `ORDER` 登録  
  - `ORDER_DETAIL` 登録  
  - `CUSTOMER`登録
  - `CART_ITEM` 削除  
  - `CART` 削除  

- **理由**
    顧客情報と注文情報とカートの整合性を保つため、すべての処理をまとめてトランザクション管理する必要がある。
<div class = "mermaid">
stateDiagram-v2
    処理開始 --> カート確認

    カート確認 --> 注文登録（INSERT） : 注文確定
    注文登録（INSERT） --> Rollback : エラー
    注文登録（INSERT） --> 注文詳細登録（INSERT）:OK
    
    注文詳細登録（INSERT）--> Rollback :エラー

    注文詳細登録（INSERT）-->顧客情報登録（INSERT）:OK
    
    顧客情報登録（INSERT）-->Rollback:エラー

    顧客情報登録（INSERT）-->カート削除（DELETE）:OK

    カート削除（DELETE）-->Rollback:エラー

    カート削除（DELETE）-->Commit:OK

    Rollback-->エラー処理

    Commit-->注文完了
</div>

## 3. 商品登録（管理者）

- **対象テーブル**  
  - `PRODUCT` 登録  
  - `PRODUCT_IMAGE` 登録  

- **理由**  
  商品情報と画像情報の不整合を防止するため、一括で登録処理をトランザクション管理する必要がある。

<div class = "mermaid">
stateDiagram-v2
    処理開始 --> 商品登録画面

    商品登録画面 --> PRODUCT（INSERT）
    
    PRODUCT（INSERT） --> Rollback:エラー

    PRODUCT（INSERT）-->PRODUCT_IMAGE（INSERT） :OK

    PRODUCT_IMAGE（INSERT）-->Rollback:エラー

    PRODUCT_IMAGE（INSERT）-->Commit:OK

    Rollback-->エラー処理

    Commit-->登録完了
</div>

## 4. 商品編集（管理者）

- **対象テーブル**  
  - `PRODUCT` 更新  
  - `PRODUCT_IMAGE` の追加・削除

- **理由**  
  商品情報の一貫性を保つため、複数テーブルの更新をトランザクション管理で一括処理する必要がある。

<div class = "mermaid">
stateDiagram-v2
    処理開始 --> 商品編集画面

    商品編集画面-->PRODUCT（UPDATE）
    PRODUCT（UPDATE）-->Rollback:エラー
    PRODUCT（UPDATE） --> PRODUCT_IMAGE（INSERT,DELETE） : OK
    PRODUCT_IMAGE（INSERT,DELETE） --> Rollback : エラー
    PRODUCT_IMAGE（INSERT,DELETE）--> Commit:OK
    Rollback--> エラー処理
    Commit-->編集完了
</div>